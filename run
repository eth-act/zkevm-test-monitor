#!/bin/bash
# run - Main entry point for ZKVM testing

set -e

CMD=${1:-help}
shift || true

case "$CMD" in
    build)
        echo "ğŸ”¨ Building ZKVMs: ${@:-all}"
        ./src/build.sh "$@"
        ;;

    test)
        DISPLAY_TARGETS="${@:-all}"
        echo "ğŸ§ª Testing ZKVMs: ${DISPLAY_TARGETS}"
        ./src/test.sh "$@"
        python3 src/update.py
        ;;

    update)
        echo "ğŸ“Š Updating dashboard"
        python3 src/update.py
        ;;

    all)
        DISPLAY_TARGETS="${@:-all}"
        echo "ğŸš€ Building and testing: ${DISPLAY_TARGETS}"
        ./src/build.sh "$@"
        ./src/test.sh "$@"
        python3 src/update.py
        ;;

    serve)
        echo "ğŸŒ Server at http://localhost:8000/"
        echo "   Press Ctrl+C to stop"
        cd docs && python3 -m http.server 8000 --bind 127.0.0.1
        ;;

    clean)
        echo "ğŸ§¹ Cleaning artifacts"
        rm -rf binaries/ test-results/*/
        ;;

    *)
        cat << EOF
Usage: ./run COMMAND [OPTIONS]

Commands:
  build [zkvm ...]          Build ZKVM binaries
  test [zkvm ...]           Run ACT4 compliance tests
  all [zkvm ...]            Build + test + update dashboard
  update                    Regenerate dashboard HTML
  serve                     Start local web server at localhost:8000
  clean                     Remove build artifacts

Environment Variables:
  JOBS=N                    Limit to N CPU cores
  ACT4_JOBS=N               Override parallel test jobs inside container
  FORCE=1                   Force rebuild of binaries

Examples:
  ./run build sp1
  ./run test sp1 jolt
  ./run test                # test all ZKVMs
  ./run all
  JOBS=8 ./run test zisk
EOF
        ;;
esac
